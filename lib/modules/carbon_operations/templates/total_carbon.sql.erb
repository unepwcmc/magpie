-- SELECT SUM(carbon) as carbon FROM (
--   SELECT ST_AREA(
--     ST_Transform(ST_SetSRID(ST_INTERSECTION(b.the_geom, a.the_geom), 4326), 27040)
--   )/10000*c_mg_ha as carbon
--   FROM <%= carbon_view_name %> a
--   INNER JOIN (SELECT ST_SetSRID(<%= the_geom %>, 4326) as the_geom) b
--   ON ST_Intersects(a.the_geom, b.the_geom)
--   WHERE country_id = '<%= country_iso %>'
-- ) c;

SELECT DISTINCT(area*c_mg_ha) AS carbon, c_mg_ha, area FROM (
  SELECT SUM(area) AS area, habitat, country
  FROM (
    SELECT ST_AREA(ST_Transform(ST_SetSRID(ST_INTERSECTION(b.the_geom, mng.the_geom), 4326), 27040))/10000 AS area, habitat, mng.cartodb_id, mng.country_id country
      FROM <%= habitat_view_name('mangrove') %> mng
      INNER JOIN (SELECT ST_SetSRID(<%= the_geom %>, 4326) as the_geom) b
      ON ST_Intersects(mng.the_geom, b.the_geom)
      WHERE mng.country_id = '<%= country_iso %>'

    UNION ALL

     SELECT ST_AREA(ST_Transform(ST_SetSRID(ST_INTERSECTION(b.the_geom, mng.the_geom), 4326), 27040))/10000 AS area, habitat, mng.cartodb_id, mng.country_id country
      FROM <%= habitat_view_name('saltmarsh') %> mng
      INNER JOIN (SELECT ST_SetSRID(<%= the_geom %>, 4326) as the_geom) b
      ON ST_Intersects(mng.the_geom, b.the_geom)
      WHERE mng.country_id = '<%= country_iso %>'

    UNION ALL

     SELECT ST_AREA(ST_Transform(ST_SetSRID(ST_INTERSECTION(b.the_geom, mng.the_geom), 4326), 27040))/10000 AS area, habitat, mng.cartodb_id, mng.country_id country
      FROM <%= habitat_view_name('seagrass') %> mng
      INNER JOIN (SELECT ST_SetSRID(<%= the_geom %>, 4326) as the_geom) b
      ON ST_Intersects(mng.the_geom, b.the_geom)
      WHERE mng.country_id = '<%= country_iso %>'

    UNION ALL

     SELECT ST_AREA(ST_Transform(ST_SetSRID(ST_INTERSECTION(b.the_geom, mng.the_geom), 4326), 27040))/10000 AS area, habitat, mng.cartodb_id, mng.country_id country
      FROM <%= habitat_view_name('algal_mat') %>
      INNER JOIN (SELECT ST_SetSRID(<%= the_geom %>, 4326) as the_geom) b
      ON ST_Intersects(mng.the_geom, b.the_geom)
      WHERE mng.country_id = '<%= country_iso %>'

      ) c

  GROUP BY habitat, country ) AS habitat_intersect
INNER JOIN <%= carbon_view_name %> carbon
ON habitat_intersect.country = carbon.country_id AND habitat_intersect.habitat = carbon.habitat
